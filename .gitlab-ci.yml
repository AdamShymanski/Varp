default:
  image: node:latest

stages:
  - initialize
  - build
  - test
  - preview
  - deploy

cache:
  paths:
    - node_modules/

initialize:
  stage: initialize
  only:
    - merge_requests
    - $CI_DEFAULT_BRANCH
  script:
    - yarn
    - npx lerna bootstrap

build:ui:
  stage: build
  only:
    - merge_requests
    - $CI_DEFAULT_BRANCH
  cache:
    policy: pull
    paths:
      - node_modules/
  script:
    - npx lerna run --scope @pyramid/ui build --stream
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - packages/ui/dist/

build:client:
  stage: build
  only:
    - merge_requests
    - $CI_DEFAULT_BRANCH
  cache:
    policy: pull
    paths:
      - node_modules/
  script:
    - npx lerna run --scope @pyramid/client build --stream
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - packages/client/dist/

test:
  stage: test
  only:
    - merge_requests
    - $CI_DEFAULT_BRANCH
  script:
    - echo test

preview:
  stage: preview
  only:
    - merge_requests
    - $CI_DEFAULT_BRANCH
  before_script:
    - npm install -g firebase-tools
  script:
    - firebase hosting:channel:deploy $CI_COMMIT_REF_SLUG --non-interactive --token=$FIREBASE_TOKEN

deploy_client:
  stage: deploy
  only:
    refs:
      - $CI_DEFAULT_BRANCH
  before_script:
    - npm install -g firebase-tools
  script:
    - firebase hosting:clone pyramid-64ab2:$CI_COMMIT_REF_SLUG pyramid-64ab2:live --non-interactive --token=$FIREBASE_TOKEN

deploy_functions:
  stage: deploy
  only:
    refs:
      - $CI_DEFAULT_BRANCH
    changes:
      - functions/**/*
  before_script:
    - npm install -g firebase-tools
  script:
    - cd functions
    - npm install
    - cd ..
    - firebase deploy --only functions --non-interactive --token=$FIREBASE_TOKEN